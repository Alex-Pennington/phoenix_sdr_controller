# GitHub Actions Release Workflow
# Triggered when a version tag (v*) is pushed
# Builds the project and creates a GitHub Release with attestation

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          # Use vcpkg.json manifest mode (automatically installs dependencies)
          runVcpkgInstall: true
          # Pin to a specific vcpkg commit for reproducibility
          vcpkgGitCommitId: 'c82f74667287d3dc386bce81e44964370c91a289'
          
      - name: Configure CMake
        run: |
          cmake -B build -S . `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DCMAKE_BUILD_TYPE=Release
        
      - name: Build
        run: cmake --build build --config Release
        
      - name: Get version from tag
        id: version
        shell: bash
        run: |
          # Tag format: v0.3.0+1.abc1234
          # Extract just the version part for display
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "FULL_VERSION=$TAG" >> $GITHUB_OUTPUT
          
          # Extract semantic version (before the +)
          SEMVER=$(echo "$TAG" | cut -d'+' -f1)
          echo "SEMVER=$SEMVER" >> $GITHUB_OUTPUT
          
          # Detect prerelease (contains -alpha, -beta, -rc)
          if [[ "$TAG" =~ -alpha|-beta|-rc ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Prepare release package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.FULL_VERSION }}"
          $semver = "${{ steps.version.outputs.SEMVER }}"
          $releaseDir = "phoenix_sdr_controller-v$semver-win64"
          
          # Create release directory
          New-Item -ItemType Directory -Path $releaseDir -Force
          
          # Copy executable (check both Release subdir and build root)
          if (Test-Path "build\Release\phoenix_sdr_controller.exe") {
            Copy-Item "build\Release\phoenix_sdr_controller.exe" $releaseDir\
          } elseif (Test-Path "build\phoenix_sdr_controller.exe") {
            Copy-Item "build\phoenix_sdr_controller.exe" $releaseDir\
          } else {
            Write-Error "Executable not found!"
            Get-ChildItem -Recurse build\*.exe
            exit 1
          }
          
          # Copy SDL2 DLLs from vcpkg installed directory
          $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\x64-windows\bin"
          if (Test-Path $vcpkgBin) {
            Copy-Item "$vcpkgBin\SDL2.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\SDL2_ttf.dll" $releaseDir\ -ErrorAction SilentlyContinue
            # Also copy any other required DLLs (freetype, zlib, etc. for SDL2_ttf)
            Copy-Item "$vcpkgBin\freetype.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\zlib1.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\bz2.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\brotlicommon.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\brotlidec.dll" $releaseDir\ -ErrorAction SilentlyContinue
            Copy-Item "$vcpkgBin\libpng16.dll" $releaseDir\ -ErrorAction SilentlyContinue
          }
          
          # Also check build directory for DLLs (in case CMake copied them)
          Get-ChildItem "build\*.dll" -ErrorAction SilentlyContinue | Copy-Item -Destination $releaseDir\ -ErrorAction SilentlyContinue
          Get-ChildItem "build\Release\*.dll" -ErrorAction SilentlyContinue | Copy-Item -Destination $releaseDir\ -ErrorAction SilentlyContinue
          
          # Create README
          $readme = "Phoenix SDR Controller v$version`n"
          $readme += "================================`n`n"
          $readme += "A Windows GUI application for remote control of the Phoenix SDR (SDRplay RSP2 Pro).`n`n"
          $readme += "Usage:`n"
          $readme += "1. Extract all files to a folder`n"
          $readme += "2. Run phoenix_sdr_controller.exe`n"
          $readme += "3. Connect to your Phoenix SDR server on port 4535`n`n"
          $readme += "Requirements:`n"
          $readme += "- Windows 10 or later (64-bit)`n"
          $readme += "- Phoenix SDR server running on target machine`n`n"
          $readme += "For more information, see: https://github.com/Alex-Pennington/phoenix_sdr_controller`n"
          $readme | Out-File -FilePath "$releaseDir\README.txt" -Encoding UTF8
          
          # List contents for debugging
          Write-Host "Release package contents:"
          Get-ChildItem $releaseDir
          
          # Create ZIP
          Compress-Archive -Path $releaseDir -DestinationPath "phoenix_sdr_controller-v$semver-win64.zip"
          
          Write-Host "Created: phoenix_sdr_controller-v$semver-win64.zip"
          
      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'phoenix_sdr_controller-v${{ steps.version.outputs.SEMVER }}-win64.zip'
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Phoenix SDR Controller v${{ steps.version.outputs.SEMVER }}
          body: |
            ## Phoenix SDR Controller v${{ steps.version.outputs.SEMVER }}
            
            **Full version:** `${{ steps.version.outputs.FULL_VERSION }}`
            
            Windows GUI application for remote control of the Phoenix SDR.
            
            ### Installation
            1. Download `phoenix_sdr_controller-v${{ steps.version.outputs.SEMVER }}-win64.zip`
            2. Extract to a folder
            3. Run `phoenix_sdr_controller.exe`
            
            ### Verification
            This release includes artifact attestation. Verify with:
            ```
            gh attestation verify phoenix_sdr_controller-v${{ steps.version.outputs.SEMVER }}-win64.zip --owner Alex-Pennington
            ```
          files: |
            phoenix_sdr_controller-v${{ steps.version.outputs.SEMVER }}-win64.zip
          draft: false
          prerelease: ${{ steps.version.outputs.PRERELEASE }}

